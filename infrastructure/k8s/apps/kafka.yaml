apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: kafka-local
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: registry-1.docker.io
    targetRevision: 32.4.3
    chart: bitnamicharts/kafka
    helm:
      releaseName: kafka
      valuesObject:
        # FIX: Exakter Tag f端r Kafka 4.0 [2]
        image:
          registry: docker.io
          repository: bitnami/kafka
          tag: "4.0.0-debian-12-r10"
          pullPolicy: IfNotPresent

        # Konfiguration f端r Kafka 4.0 (KRaft ist jetzt Standard, 'kraft.enabled' ist deprecated)
        zookeeper:
          enabled: false

        # Single-Node Combined Mode (Controller + Broker in einem Pod)
        controller:
          replicaCount: 1
          # WICHTIG: Heap reduzieren, sonst killt K3d den Pod (OOM)
          heapOpts: "-Xmx512m -Xms512m"
          resources:
            limits:
              memory: "1Gi"
          # Anti-Affinity deaktivieren f端r Single-Node Cluster
          podAntiAffinityPreset: ""
          affinity: {}
        
        broker:
          replicaCount: 0 # 0 Broker, da der Controller diese Rolle 端bernimmt
          podAntiAffinityPreset: ""
          affinity: {}

        listeners:
          client:
            protocol: PLAINTEXT
          controller:
            protocol: PLAINTEXT
          interbroker:
            protocol: PLAINTEXT
          external:
            protocol: PLAINTEXT

  destination:
    server: https://kubernetes.default.svc
    namespace: database-services
  
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true